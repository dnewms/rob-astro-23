---
import { fetchInstagramPosts, fetchYoutubePosts, fetchTwitterPosts } from '../lib/social';
import { Icon } from 'astro-icon';

function truncateText(text, maxLength = 250) {
  return text.length <= maxLength ? text : text.slice(0, maxLength) + '...';
}

async function fetchSocialPosts() {
  const [instagramPost] = await fetchInstagramPosts();
  const [youtubePost] = await fetchYoutubePosts();
  const [twitterPost] = await fetchTwitterPosts();
  return [instagramPost, youtubePost, twitterPost]
    .filter(Boolean)
    .map(post => ({
      ...post,
      content: truncateText(post.content)
    }));
}

const posts = await fetchSocialPosts();

const socialLinks = {
  Instagram: 'https://www.instagram.com/umrobotics/',
  YouTube: 'https://www.youtube.com/channel/UC-WH2n-SkB166pUq5o5ULUg',
  Twitter: 'https://x.com/umrobotics'
};

const socialIcons = {
  Instagram: 'mdi:instagram',
  YouTube: 'mdi:youtube',
  X: 'twitter-x-logo'
};
---
<div class="relative mb-16 border-t border-maize before:absolute before:left-0 before:top-0 before:w-px before:h-1/3 before:bg-gradient-to-b before:from-maize before:to-transparent after:absolute after:right-0 after:top-0 after:w-px after:h-1/3 after:bg-gradient-to-b after:from-maize after:to-transparent">
  <div class="flex justify-center mb-2 sm:mb-0">
      <h2 class="absolute -top-6 z-10 bg-maize text-umichblue dark:bg-maize dark:text-white px-6 py-2 rounded-sm text-3xl font-bold">Social media</h2>
    </div>
      <div class="flex flex-wrap gap-4 justify-center mb-8 md:flex-nowrap pt-10 px-2">
        {posts.map((post) => (
          <div class="w-80 h-[24rem] rounded-sm overflow-hidden shadow-xl bg-white dark:bg-gray-800 relative transform transition-all duration-300 hover:scale-[1.02] hover:shadow-2xl">
            {(post.platform === 'Instagram' ||  
              (post.platform === 'X' && post.mediaType === 'IMAGE' && post.mediaUrl) || 
              (post.platform !== 'Instagram' && post.thumbnailUrl)) ? (
              <div class="h-44 relative">
                {post.platform === 'Instagram' && post.mediaType === 'IMAGE' && post.mediaUrl && (
                  <img class="w-full h-full object-cover" src={post.mediaUrl} alt="Instagram post" />
                )}
                {post.platform === 'Instagram' && post.mediaType === 'VIDEO' && post.thumbnailUrl && (
                  <img class="w-full h-full object-cover" src={post.thumbnailUrl} alt="Instagram video thumbnail" />
                )}
                {post.platform === 'X' && post.mediaType === 'IMAGE' && post.mediaUrl && (
                  <img class="w-full h-full object-cover" src={post.mediaUrl} alt="X/Twitter post" />
                )}
                {post.platform !== 'Instagram' && post.thumbnailUrl && (
                  <img class="w-full h-full object-cover" src={post.thumbnailUrl} alt={post.content} />
                )}
              </div>
            ) : (
              <div class="h-44 bg-gradient-to-r from-blue-400 to-blue-600 flex items-center justify-center">
                <Icon name={socialIcons[post.platform]} class="w-16 h-16 text-white" />
              </div>
            )}
        
            <div class="p-4">
              <div class="flex justify-between items-center mb-4">
                <span class="text-sm font-medium text-gray-600 dark:text-gray-300 flex items-center">
                  <Icon name={socialIcons[post.platform]} class="w-5 h-5 mr-2 text-gray-700 dark:text-gray-300" />
                  {post.platform === 'X' ? '' : post.platform}
                </span>
                <span class="text-sm text-gray-500 dark:text-gray-400">
                  {new Date(post.date).toLocaleDateString()}
                </span>
              </div>
        
              <p class="text-gray-700 dark:text-gray-300 text-sm mb-4 line-clamp-4">
                {post.content}
              </p>
        
              <div class="absolute bottom-4 left-4 right-4">
                <a
                  href={post.link}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="w-full block text-center bg-arboretumBlue hover:bg-umichblue dark:bg-arboretumBlue dark:hover:bg-umichblue text-white dark:text-gray-200 py-2 px-4 rounded transition duration-300 ease-in-out"
                >
                  {post.platform === 'Instagram' ? 'View on' : post.platform === 'YouTube' ? 'Watch on' : 'Read on'} {post.platform}
                </a>
              </div>
            </div>
          </div>
        ))}
        
    </div>
  </div>
